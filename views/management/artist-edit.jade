extends layout
block head
    link(rel='stylesheet', href='/bootstrap-fileinput/css/fileinput.min.css')
block content
    .modal.fade(tabindex='-1', role='dialog', aria-hidden='true', data-id='album')
        .modal-dialog
            .modal-content
                .modal-header
                    button.close(type='button', data-dismiss='modal')
                        span(aria-hidden='true') ×
                        span.sr-only Close
                    h4.modal-title 专辑
                .modal-body
                    table.table.table-striped
                        thead
                            tr
                                th.col-md-1 #
                                th.col-md-3 名称
                                th.col-md-2 艺人
                                th.col-md-3 厂牌
                        tbody#body_album
                .modal-footer
                    button#btn_album.btn.btn-primary(type='button') 确定
                    button.btn.btn-default(type='button', data-dismiss='modal') 取消
    .modal.fade(tabindex='-1', role='dialog', aria-hidden='true', data-id='audio')
        .modal-dialog
            .modal-content
                .modal-header
                    button.close(type='button', data-dismiss='modal')
                        span(aria-hidden='true') ×
                        span.sr-only Close
                    h4.modal-title 音乐
                .modal-body
                    table.table.table-striped
                        thead
                            tr
                                th.col-md-1 #
                                th.col-md-3 名称
                                th.col-md-2 时长
                                th.col-md-3 路径
                        tbody
                .modal-footer
                    button.btn.btn-primary(type='button') 确定
                    button.btn.btn-default(type='button', data-dismiss='modal') 取消
    .container
        .panel.panel-default
            .panel-heading 编辑艺人/厂牌
            .panel-body
                form.form-horizontal(role='form')
                    .form-group
                        label.col-sm-2.control-label(for='inputName') 名称
                        .col-sm-10
                            input#inputName.form-control(type='text', placeholder='名称', value= artist.name)
                    .form-group
                        label.col-sm-2.control-label(for='inputInfo') 基本信息
                        .col-sm-10
                            textarea#inputInfo.form-control(rows='3')= artist.description
                    .form-group
                        label.col-sm-2.control-label(for='inputDescription') 简介
                        .col-sm-10
                            textarea#inputDescription.form-control(rows='5')= artist.infos
                    .form-group
                        label.col-sm-2.control-label(for='inputIcon') 肖像
                        .col-sm-10
                            img(src= artist.icon)
                            input#inputIcon.file(type='file', data-preview-file-type='text', data-allowed-file-extensions='["jpg", "png"]')
                    .form-group
                        label.col-sm-2.control-label 音乐
                        .col-sm-10
                            .panel.panel-default
                                .panel-heading 音乐列表
                                    a.pull-right.btn.btn-link.btn-xs.btn__add(href='javascript:;', data-target='audio') 选择
                                table.table.table-striped
                                    thead
                                        tr
                                            th.col-md-2 #
                                            th.col-md-4 名称
                                            th.col-md-4 时长
                                            th.col-md-2(col) 操作
                                    tbody
                                        each item in artist.audios
                                            -
                                                var tmp = '' + item.id
                                                tmp = tmp.substring(16)
                                            tr
                                                td= tmp
                                                td= item.title
                                                td= item.timeLength
                                                td
                                                    a(href='javascript:;') 编辑
                                                td
                                                    a(href='javascript:;') 删除
                    .form-group
                        label.col-sm-2.control-label 专辑
                        .col-sm-10
                            .panel.panel-default
                                .panel-heading 专辑列表
                                    a.pull-right.btn.btn-link.btn-xs.btn__add(href='javascript:;', data-target='album') 选择
                                table.table.table-striped
                                    thead
                                        tr
                                            th.col-md-2 #
                                            th.col-md-4 名称
                                            th.col-md-4 厂牌
                                            th.col-md-2 发行时间
                                    tbody#main_albums
                                        each item in artist.albums
                                            -
                                                var tmp = '' + item._id
                                                tmp = tmp.substring(16)
                                            tr
                                                td= tmp
                                                td= item.name
                                                td= item.label
                                                td= item.datetime

                    .form-group
                        label.col-sm-2.control-label 视频
                        .col-sm-10
                            .panel.panel-default
                                .panel-heading 视频列表
                                    a.pull-right.btn.btn-link.btn-xs(href='javascript:;') 新增
                                table.table.table-striped
                                    thead
                                        tr
                                            th.col-md-2 封面
                                            th.col-md-2 名称
                                            th.col-md-6 路径
                                            th.col-md-2 操作
                                    tbody
                                        each item in artist.videos
                                            tr
                                                td
                                                    .row
                                                        .col-md-12
                                                            a.thumbnail(href='javascript:;')
                                                                img(style='width: 100%; display: block;', src=item.pic, data-holder-rendered='true')
                                                td= item.title
                                                td= item.path
                                                td
                                                    a(href='javascript:;') 删除

                    .form-group
                        label.col-sm-2.control-label 档期
                        .col-sm-10
                            .panel.panel-default
                                .panel-heading 档期列表
                                    a.pull-right.btn.btn-link.btn-xs(href='javascript:;') 新增
                                table.table.table-striped
                                    thead
                                        tr
                                            th.col-md-3 时间
                                            th.col-md-4 场地
                                            th.col-md-3 位置
                                            td.col-md-2 操作
                                    tbody
                                        each item in artist.schedule
                                            tr
                                                td= item.time
                                                td= item.venue
                                                td= item.addr
                                                td
                                                    a(href='javascript:;') 删除

                    .form-group
                        .col-sm-offset-10.col-sm-2
                            button#btn_submit.btn.btn-default(type='button').btn-block 提交
block footer
    script(src='/bootstrap-fileinput/js/plugins/canvas-to-blob.js')
    script(src='/bootstrap-fileinput/js/plugins/sortable.js')
    script(src='/bootstrap-fileinput/js/plugins/purify.js')
    script(src='/bootstrap-fileinput/js/fileinput.js')
    script(src='/bootstrap-fileinput/js/locales/zh.js')
    script.
        (function () {
            $('#inputIcon').fileinput({language: 'zh'});

            var $btn__add = $('a.btn__add');
            $btn__add.on('click', function(){
                var id = $(this).attr('data-target');
                var $target = $('.modal[data-id="' + id + '"]');
                $target.modal('show');
                switch(id) {
                    case 'album':
                        $.getJSON('/api/management/albums', function (res) {
                            var list = [];
                            for (var i in res) {
                                var item = res[i];
                                var listItem = [];
                                listItem.push('<tr>');
                                listItem.push('<td><input data-id="' + item._id + '" type="checkbox"></td>');
                                listItem.push('<td>');
                                listItem.push(item.name);
                                listItem.push('</td>');
                                listItem.push('<td>');
                                listItem.push(item.artist);
                                listItem.push('</td>');
                                listItem.push('<td>');
                                listItem.push(item.label);
                                listItem.push('</td>');
                                listItem.push('</tr>');
                                list.push(listItem.join(''));
                            }
                            $target.find('tbody').html(list.join(''));
                        });
                        break;
                    case 'audio':
                        $.getJSON('/api/management/audios', function (res) {
                            var list = [];
                            for (var i in res) {
                                var item = res[i];
                                var listItem = [];
                                listItem.push('<tr>');
                                listItem.push('<td><input type="checkbox"></td>');
                                listItem.push('<td>');
                                listItem.push(item.title);
                                listItem.push('</td>');
                                listItem.push('<td>');
                                listItem.push(item.timeLength);
                                listItem.push('</td>');
                                listItem.push('<td>');
                                listItem.push(item.path);
                                listItem.push('</td>');
                                listItem.push('</tr>');
                                list.push(listItem.join(''));
                            }
                            $target.find('tbody').html(list.join(''));
                        });
                        break;
                }
            });

            var $body_album = $('#body_album');
            var $btn_album = $('#btn_album');

            var $main_albums = $('#main_albums');

            $btn_album.on('click', function() {
                var $chks = $body_album.find('input:checked');
                var data = {
                    chks: []
                }
                for(var i = 0, len = $chks.length; i < len; ++i) {
                    var item = $chks[i];
                    var $item = $(item);
                    var id = $item.attr('data-id');
                    data.chks.push(id);
                }
                $.getJSON('/api/management/albums-by-ids', data, function(res) {
                    var list = [];
                    for (var i in res) {
                        var item = res[i];
                        var tmp = '' + item._id
                        tmp = tmp.substring(16)
                        var listItem = [];
                        listItem.push('<tr>');
                        listItem.push('<td>');
                        listItem.push(tmp);
                        listItem.push('</td>');
                        listItem.push('<td>');
                        listItem.push(item.name);
                        listItem.push('</td>');
                        listItem.push('<td>');
                        listItem.push(item.label);
                        listItem.push('</td>');
                        listItem.push('<td>');
                        listItem.push(item.datetime);
                        listItem.push('</td>');
                        listItem.push('</tr>');
                        list.push(listItem.join(''));
                    }
                    $main_albums.html(list.join(''));
                    $('.modal[data-id="album"]').modal('hide');
                });
            })
        })();